import logging
import os
import sqlite3
import asyncio
import datetime
from urllib.parse import urlparse
from aiogram import Bot, Dispatcher, types, F
from aiogram.enums import ParseMode
from aiogram.filters import CommandStart, Command
from aiogram.fsm.state import State, StatesGroup
from aiogram.fsm.context import FSMContext
from aiogram.utils.markdown import hbold, hcode
from aiogram.client.default import DefaultBotProperties
from dotenv import load_dotenv
from aiohttp import web

# Load .env variables
load_dotenv()

# --- Configuration from Environment Variables ---
API_TOKEN = os.getenv("BOT_TOKEN")
ADMIN_CHAT_ID = os.getenv("ADMIN_CHAT_ID")
WEB_SERVER_URL = os.getenv("WEB_SERVER_URL") # Example: https://your-render-app.onrender.com

# --- Bot Initialization ---
bot = Bot(token=API_TOKEN, default=DefaultBotProperties(parse_mode=ParseMode.HTML))
dp = Dispatcher()
logging.basicConfig(level=logging.INFO)

# --- FSM States for Profile Setup ---
class ProfileSetup(StatesGroup):
    name = State()
    phone = State()
    email = State()
    bkash = State()
    binance_id = State()
    youtube = State()
    facebook = State()
    tiktok = State()
    website = State()
    about_yourself = State()

# --- FSM States for Withdrawal ---
class Withdrawal(StatesGroup):
    amount = State()
    payment_method = State()
    comment = State()

# --- SQLite Database Setup ---
conn = sqlite3.connect("bot.db")
cur = conn.cursor()

# Create/Update tables
# employees table: user details and profile info, now with banned and is_editor flags
cur.execute("""
CREATE TABLE IF NOT EXISTS employees (
    username TEXT PRIMARY KEY,
    telegram_id INTEGER UNIQUE,
    is_admin BOOLEAN DEFAULT 0,
    is_editor BOOLEAN DEFAULT 0,
    profile_set BOOLEAN DEFAULT 0,
    banned BOOLEAN DEFAULT 0,
    full_name TEXT,
    phone_number TEXT,
    email TEXT,
    bkash_number TEXT,
    binance_id TEXT,
    youtube_link TEXT,
    facebook_link TEXT,
    tiktok_link TEXT,
    website_link TEXT,
    about_yourself TEXT,
    total_visits INTEGER DEFAULT 0,
    total_clicks INTEGER DEFAULT 0,
    usdt_balance REAL DEFAULT 0.0
)
""")

# domains table: to store allowed movie site domains (from previous)
cur.execute("""
CREATE TABLE IF NOT EXISTS domains (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT UNIQUE,
    base_url TEXT
)
""")

# global_tasks table: for a single task assigned to all employees (from previous)
cur.execute("""
CREATE TABLE IF NOT EXISTS global_tasks (
    id INTEGER PRIMARY KEY DEFAULT 1,
    task_identifier TEXT,
    domain_id INTEGER,
    last_set_date TEXT,
    FOREIGN KEY (domain_id) REFERENCES domains(id)
)
""")

# individual_tasks table: for tasks assigned to specific employees (from previous)
cur.execute("""
CREATE TABLE IF NOT EXISTS individual_tasks (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    employee_username TEXT,
    task_identifier TEXT,
    domain_id INTEGER,
    assigned_by TEXT,
    assigned_date TEXT DEFAULT CURRENT_TIMESTAMP,
    status TEXT DEFAULT 'pending',
    FOREIGN KEY (employee_username) REFERENCES employees(username),
    FOREIGN KEY (domain_id) REFERENCES domains(id)
)
""")

# clicks table: to track user clicks and duration, now with more details
cur.execute("""
CREATE TABLE IF NOT EXISTS clicks (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    ref_by_employee TEXT, -- The employee's username
    viewer_telegram_id INTEGER, -- The Telegram ID of the user who clicked
    viewer_username TEXT, -- The Telegram username of the user who clicked
    viewer_full_name TEXT, -- The Telegram full name of the user who clicked
    user_agent TEXT, -- Browser user agent
    page_url TEXT,
    timestamp DATETIME DEFAULT CURRENT_TIMESTAMP,
    is_visit BOOLEAN DEFAULT 0, -- True if stayed >= 12 seconds
    is_click BOOLEAN DEFAULT 0, -- True if detected, regardless of duration
    is_telegram_browser BOOLEAN DEFAULT 0, -- True if opened in Telegram's internal browser
    unique_daily_key TEXT UNIQUE -- For 20 visits per day limit (username + date + ref_by_employee + page_url)
)
""")

# New tables for public lists
cur.execute("""
CREATE TABLE IF NOT EXISTS channels (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT UNIQUE,
    description TEXT,
    link TEXT UNIQUE
)
""")

cur.execute("""
CREATE TABLE IF NOT EXISTS earning_bots (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT UNIQUE,
    description TEXT,
    link TEXT UNIQUE
)
""")

# Global settings for visit to USDT rate
cur.execute("""
CREATE TABLE IF NOT EXISTS global_settings (
    key TEXT PRIMARY KEY,
    value TEXT
)
""")
# Initialize default USDT rate if not exists
cur.execute("INSERT OR IGNORE INTO global_settings (key, value) VALUES (?, ?)", ('usdt_rate_per_1000_visits', '1.00'))

# New table for withdrawal requests
cur.execute("""
CREATE TABLE IF NOT EXISTS withdraw_requests (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    employee_username TEXT,
    usdt_amount REAL,
    payment_method TEXT, -- 'Bkash' or 'Binance'
    payment_detail TEXT, -- The Bkash number or Binance ID from profile
    comment TEXT, -- User's 60 char comment
    request_date DATETIME DEFAULT CURRENT_TIMESTAMP,
    status TEXT DEFAULT 'pending', -- 'pending', 'approved', 'rejected'
    FOREIGN KEY (employee_username) REFERENCES employees(username)
)
""")

conn.commit()

# --- Helper functions ---
def is_admin(user_id):
    return str(user_id) == ADMIN_CHAT_ID

def is_editor(user_id):
    cur.execute("SELECT is_editor FROM employees WHERE telegram_id = ?", (user_id,))
    result = cur.fetchone()
    return result and result[0] == 1

# Define commands that editors can also use (subset of admin commands)
# These are commands where editor access is granted via the `has_editor_permission` function
EDITOR_ALLOWED_ADMIN_COMMANDS = [
    "list_employees", # Already handled by is_admin or is_editor check directly in handler
    "click_user_list",
    "report", # Adding report for editors
    "list_domains", # Adding list_domains for editors
    "channel_list", # Editors can see public lists
    "earning_bot_list", # Editors can see public lists
    "site_list" # Editors can see public lists
]

def has_editor_permission(user_id, command_name):
    if not is_editor(user_id):
        return False
    # Check if the command (without '/') is in the allowed list
    # The command_name from message.text will be like "click_user_list"
    return command_name in EDITOR_ALLOWED_ADMIN_COMMANDS


# --- Telegram Bot Command Handlers ---

# START Command - Improved Welcome Message & Public Commands
@dp.message(CommandStart())
async def send_welcome(message: types.Message, state: FSMContext):
    user_username = message.from_user.username
    user_id = message.from_user.id

    welcome_message = (
        "üëã <b>‡¶∏‡ßç‡¶¨‡¶æ‡¶ó‡¶§‡¶Æ!</b> ‡¶è‡¶á ‡¶¨‡¶ü ‡¶Ü‡¶™‡¶®‡¶æ‡¶ï‡ßá ‡¶Ö‡¶®‡¶≤‡¶æ‡¶á‡¶®‡ßá ‡¶Ü‡¶Ø‡¶º ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ö‡¶Æ‡ßé‡¶ï‡¶æ‡¶∞ ‡¶∏‡ßÅ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßá ‡¶¶‡ßá‡¶¨‡ßá‡•§ ‡¶∏‡¶π‡¶ú ‡¶ü‡¶æ‡¶∏‡ßç‡¶ï ‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶ï‡¶∞‡ßá ‡¶Ü‡¶™‡¶®‡¶ø ‡¶∏‡¶π‡¶ú‡ßá‡¶á USDT ‡¶â‡¶™‡¶æ‡¶∞‡ßç‡¶ú‡¶® ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡¶®!\n\n"
        "Hello! This bot offers you an excellent opportunity to earn online. Complete simple tasks and easily earn USDT!\n\n"
    )
    
    # Check if user is an employee
    cur.execute("SELECT profile_set, banned FROM employees WHERE username = ? OR telegram_id = ?", (user_username, user_id))
    employee_status = cur.fetchone()

    is_already_employee = False
    profile_is_set = False
    is_banned = False

    if employee_status:
        is_already_employee = True
        profile_is_set = employee_status[0]
        is_banned = employee_status[1]

    if is_banned:
        welcome_message += "üö´ ‡¶¶‡ßÅ‡¶É‡¶ñ‡¶ø‡¶§, ‡¶Ü‡¶™‡¶®‡¶ø ‡¶è‡¶á ‡¶¨‡¶ü ‡¶•‡ßá‡¶ï‡ßá ‡¶®‡¶ø‡¶∑‡¶ø‡¶¶‡ßç‡¶ß (banned) ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡¶®‡•§ ‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡ßã‡¶®‡ßã ‡¶ï‡¶æ‡¶∞‡ßç‡¶Ø‡¶ï‡ßç‡¶∞‡¶Æ ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡¶® ‡¶®‡¶æ‡•§"
        await message.reply(welcome_message, parse_mode=ParseMode.HTML)
        return

    if is_already_employee:
        welcome_message += "‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏: <b>‡¶è‡¶Æ‡¶™‡ßç‡¶≤‡ßü‡¶ø</b>\n\n"
        if not profile_is_set:
            welcome_message += "‚ö†Ô∏è ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶®‡ßá‡¶á‡•§ ‡¶¶‡¶Ø‡¶º‡¶æ ‡¶ï‡¶∞‡ßá `/set_profile` ‡¶ï‡¶Æ‡¶æ‡¶®‡ßç‡¶° ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®‡•§"
            # Start profile setup FSM if not set
            await state.set_state(ProfileSetup.name)
            await message.answer("‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ <b>‡¶™‡ßÅ‡¶∞‡ßã ‡¶®‡¶æ‡¶Æ</b> ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®:") # Initial prompt for profile setup
            return # Exit early to proceed with FSM
    else:
        welcome_message += "‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶Ü‡¶Æ‡¶æ‡¶¶‡ßá‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶ï‡¶æ‡¶ú ‡¶ï‡¶∞‡ßá ‡¶Ü‡¶Ø‡¶º ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®? `/join_employee` ‡¶ï‡¶Æ‡¶æ‡¶®‡ßç‡¶° ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßá ‡¶è‡¶ï‡¶ú‡¶® ‡¶è‡¶Æ‡¶™‡ßç‡¶≤‡¶Ø‡¶º‡¶ø ‡¶π‡¶ø‡¶∏‡ßá‡¶¨‡ßá ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶π‡¶®!\n\n"
        
    welcome_message += (
        "üåê <b>‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£ ‡¶ï‡¶Æ‡¶æ‡¶®‡ßç‡¶°‡¶∏‡¶Æ‡ßÇ‡¶π:</b>\n"
        "/bot_info - ‡¶è‡¶á ‡¶¨‡¶ü ‡¶∏‡¶Æ‡ßç‡¶™‡¶∞‡ßç‡¶ï‡ßá ‡¶ú‡¶æ‡¶®‡ßÅ‡¶®\n"
        "/help_group - ‡¶∏‡¶æ‡¶π‡¶æ‡¶Ø‡ßç‡¶Ø ‡¶™‡ßá‡¶§‡ßá ‡¶ó‡ßç‡¶∞‡ßÅ‡¶™‡ßá ‡¶Ø‡ßã‡¶ó ‡¶¶‡¶ø‡¶®\n"
        "/contact - ‡¶Ü‡¶Æ‡¶æ‡¶¶‡ßá‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®\n"
        "/channel_list - ‡¶Ü‡¶Æ‡¶æ‡¶¶‡ßá‡¶∞ ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤‡¶ó‡ßÅ‡¶≤‡ßã ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®\n"
        "/earning_bot_list - ‡¶Ü‡¶Ø‡¶º‡ßá‡¶∞ ‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø ‡¶¨‡¶ü ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®\n"
        "/site_list - ‡¶Ü‡¶Æ‡¶æ‡¶¶‡ßá‡¶∞ ‡¶ì‡¶Ø‡¶º‡ßá‡¶¨‡¶∏‡¶æ‡¶á‡¶ü‡¶ó‡ßÅ‡¶≤‡ßã ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®\n"
        "/em_cmd - ‡¶è‡¶Æ‡¶™‡ßç‡¶≤‡¶Ø‡¶º‡¶ø ‡¶ï‡¶Æ‡¶æ‡¶®‡ßç‡¶° ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ (‡¶Ø‡¶¶‡¶ø ‡¶Ü‡¶™‡¶®‡¶ø ‡¶è‡¶Æ‡¶™‡ßç‡¶≤‡¶Ø‡¶º‡¶ø ‡¶π‡¶®)\n"
    )
    await message.reply(welcome_message, parse_mode=ParseMode.HTML)


# --- Public Commands (already has is_editor_permission for list, channel_list, earning_bot_list, site_list) ---
@dp.message(Command("bot_info"))
async def bot_info_handler(message: types.Message):
    info_text = (
        "ü§ñ <b>‡¶Ü‡¶≤‡ßÅ‡¶Æ‡¶ø‡¶®‡ßç‡¶ü ‡¶ü‡¶æ‡¶∏‡ßç‡¶ï ‡¶¨‡¶ü - ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Ü‡¶Ø‡¶º‡ßá‡¶∞ ‡¶∏‡¶ô‡ßç‡¶ó‡ßÄ!</b>\n\n"
        "‡¶è‡¶á ‡¶¨‡¶ü‡¶ü‡¶ø ‡¶Ü‡¶™‡¶®‡¶æ‡¶ï‡ßá ‡¶¨‡¶ø‡¶≠‡¶ø‡¶®‡ßç‡¶® ‡¶Ö‡¶®‡¶≤‡¶æ‡¶á‡¶® ‡¶ü‡¶æ‡¶∏‡ßç‡¶ï (‡¶Ø‡ßá‡¶Æ‡¶® ‡¶ì‡¶Ø‡¶º‡ßá‡¶¨‡¶∏‡¶æ‡¶á‡¶ü ‡¶≠‡¶ø‡¶ú‡¶ø‡¶ü, ‡¶≠‡¶ø‡¶°‡¶ø‡¶ì ‡¶¶‡ßá‡¶ñ‡¶æ) ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶® ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶Æ‡¶æ‡¶ß‡ßç‡¶Ø‡¶Æ‡ßá ‡¶∏‡¶π‡¶ú ‡¶â‡¶™‡¶æ‡¶Ø‡¶º‡ßá USDT ‡¶â‡¶™‡¶æ‡¶∞‡ßç‡¶ú‡¶® ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶∏‡ßÅ‡¶Ø‡ßã‡¶ó ‡¶¶‡ßá‡¶Ø‡¶º‡•§ ‡¶Ü‡¶Æ‡¶æ‡¶¶‡ßá‡¶∞ ‡¶è‡¶Æ‡¶™‡ßç‡¶≤‡¶Ø‡¶º‡¶ø ‡¶π‡¶ø‡¶∏‡ßá‡¶¨‡ßá ‡¶Ø‡ßã‡¶ó ‡¶¶‡¶ø‡¶Ø‡¶º‡ßá ‡¶Ü‡¶™‡¶®‡¶ø ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶≤‡¶ø‡¶Ç‡¶ï‡ßá‡¶∞ ‡¶Æ‡¶æ‡¶ß‡ßç‡¶Ø‡¶Æ‡ßá ‡¶≠‡¶ø‡¶ú‡¶ø‡¶ü‡¶∞ ‡¶è‡¶®‡ßá ‡¶Ü‡¶Ø‡¶º ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡¶®‡•§ ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶Ü‡¶™‡¶®‡¶ø ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ï‡¶æ‡¶ú‡ßá‡¶∞ ‡¶Ö‡¶ó‡ßç‡¶∞‡¶ó‡¶§‡¶ø, ‡¶Ü‡¶Ø‡¶º ‡¶è‡¶¨‡¶Ç ‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü‡ßá‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø ‡¶ü‡ßç‡¶∞‡ßç‡¶Ø‡¶æ‡¶ï ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡¶®‡•§\n\n"
        "<b>English:</b>\n"
        "ü§ñ <b>Alumint Task Bot - Your Earning Companion!</b>\n\n"
        "This bot provides you with an easy way to earn USDT by completing various online tasks (like website visits, watching videos). By joining as our employee, you can earn by bringing visitors through your referral links. Here, you can track your work progress, earnings, and payment information."
    )
    await message.reply(info_text, parse_mode=ParseMode.HTML)

@dp.message(Command("help_group"))
async def help_group_handler(message: types.Message):
    await message.reply("Need help? Join our support group here: [ZflixCO Group](https://t.me/zflixcogroup)", parse_mode=ParseMode.HTML)

@dp.message(Command("contact"))
async def contact_handler(message: types.Message):
    await message.reply("For business inquiries or direct support, contact us: @zflix_contract", parse_mode=ParseMode.HTML)

@dp.message(Command("channel_list"))
async def channel_list_handler(message: types.Message):
    # Publicly accessible, but also included in editor permission list for clarity in has_editor_permission
    cur.execute("SELECT name, description, link FROM channels")
    channels = cur.fetchall()
    if not channels:
        return await message.reply("‚ÑπÔ∏è ‡¶ï‡ßã‡¶®‡ßã ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤ ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡¶®‡¶ø‡•§")
    
    channel_text = "üì¢ <b>‡¶Ü‡¶Æ‡¶æ‡¶¶‡ßá‡¶∞ ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤‡¶∏‡¶Æ‡ßÇ‡¶π:</b>\n\n"
    for name, desc, link in channels:
        channel_text += f"<b>{name}</b>\n{desc}\n[Join Channel]({link})\n\n"
    await message.reply(channel_text, parse_mode=ParseMode.HTML, disable_web_page_preview=True)

@dp.message(Command("earning_bot_list"))
async def earning_bot_list_handler(message: types.Message):
    # Publicly accessible, but also included in editor permission list for clarity in has_editor_permission
    cur.execute("SELECT name, description, link FROM earning_bots")
    bots = cur.fetchall()
    if not bots:
        return await message.reply("‚ÑπÔ∏è ‡¶ï‡ßã‡¶®‡ßã ‡¶Ü‡¶Ø‡¶º‡ßá‡¶∞ ‡¶¨‡¶ü ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡¶®‡¶ø‡•§")
    
    bot_text = "üí∞ <b>‡¶Ü‡¶Ø‡¶º‡ßá‡¶∞ ‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø ‡¶¨‡¶ü:</b>\n\n"
    for name, desc, link in bots:
        bot_text += f"<b>{name}</b>\n{desc}\n[Start Bot]({link})\n\n"
    await message.reply(bot_text, parse_mode=ParseMode.HTML, disable_web_page_preview=True)

@dp.message(Command("site_list"))
async def site_list_handler(message: types.Message):
    # Publicly accessible, but also included in editor permission list for clarity in has_editor_permission
    cur.execute("SELECT name, base_url FROM domains")
    domains = cur.fetchall()
    if not domains:
        return await message.reply("‚ÑπÔ∏è ‡¶ï‡ßã‡¶®‡ßã ‡¶ì‡¶Ø‡¶º‡ßá‡¶¨‡¶∏‡¶æ‡¶á‡¶ü ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡¶®‡¶ø‡•§")
    
    site_text = "üåê <b>‡¶Ü‡¶Æ‡¶æ‡¶¶‡ßá‡¶∞ ‡¶ì‡¶Ø‡¶º‡ßá‡¶¨‡¶∏‡¶æ‡¶á‡¶ü‡¶∏‡¶Æ‡ßÇ‡¶π:</b>\n\n"
    for name, url in domains:
        site_text += f"<b>{name}</b>\n[‡¶≠‡¶ø‡¶ú‡¶ø‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®]({url})\n\n"
    await message.reply(site_text, parse_mode=ParseMode.HTML, disable_web_page_preview=True)


# --- Admin Commands for Public Lists ---
@dp.message(Command("add_channel"))
async def add_channel_handler(message: types.Message):
    if not is_admin(message.from_user.id):
        return await message.reply("‚ùå ‡¶Ü‡¶™‡¶®‡¶ø ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶®‡¶®!")
    try:
        parts = message.text.split(" ", 3) # /add_channel Name: Desc: Link:
        if len(parts) < 4 or not all(p.endswith(":") for p in parts[1:3]):
            return await message.reply("‚ö†Ô∏è ‡¶∏‡¶†‡¶ø‡¶ï‡¶≠‡¶æ‡¶¨‡ßá ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®: /add_channel Channel Name: <name> Channel Description: <desc> Channel Link: <link>")
        
        # Simple parsing for now, could be more robust
        channel_name = parts[1].replace("Name:", "").strip()
        channel_desc = parts[2].replace("Description:", "").strip()
        channel_link = parts[3].replace("Link:", "").strip()

        cur.execute("INSERT INTO channels (name, description, link) VALUES (?, ?, ?)", (channel_name, channel_desc, channel_link))
        conn.commit()
        await message.reply(f"‚úÖ ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤ '{channel_name}' ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶≤‡ßã‡•§")
    except sqlite3.IntegrityError:
        await message.reply(f"‚ö†Ô∏è ‡¶è‡¶á ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤‡¶ü‡¶ø ‡¶á‡¶§‡¶ø‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá‡¶á ‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶Æ‡¶æ‡¶®‡•§")
    except Exception as e:
        await message.reply(f"‚ùå ‡¶è‡¶ï‡¶ü‡¶ø ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá: {e}")

@dp.message(Command("add_bot"))
async def add_earning_bot_handler(message: types.Message):
    if not is_admin(message.from_user.id):
        return await message.reply("‚ùå ‡¶Ü‡¶™‡¶®‡¶ø ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶®‡¶®!")
    try:
        parts = message.text.split(" ", 3) # /add_bot Name: Desc: Link:
        if len(parts) < 4 or not all(p.endswith(":") for p in parts[1:3]):
            return await message.reply("‚ö†Ô∏è ‡¶∏‡¶†‡¶ø‡¶ï‡¶≠‡¶æ‡¶¨‡ßá ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®: /add_bot Bot Name: <name> Bot Description: <desc> Bot Link: <link>")
        
        bot_name = parts[1].replace("Name:", "").strip()
        bot_desc = parts[2].replace("Description:", "").strip()
        bot_link = parts[3].replace("Link:", "").strip()

        cur.execute("INSERT INTO earning_bots (name, description, link) VALUES (?, ?, ?)", (bot_name, bot_desc, bot_link))
        conn.commit()
        await message.reply(f"‚úÖ ‡¶¨‡¶ü '{bot_name}' ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶≤‡ßã‡•§")
    except sqlite3.IntegrityError:
        await message.reply(f"‚ö†Ô∏è ‡¶è‡¶á ‡¶¨‡¶ü‡¶ü‡¶ø ‡¶á‡¶§‡¶ø‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá‡¶á ‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶Æ‡¶æ‡¶®‡•§")
    except Exception as e:
        await message.reply(f"‚ùå ‡¶è‡¶ï‡¶ü‡¶ø ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá: {e}")


# --- Employee Self-Registration: New command `join_employee` ---
@dp.message(Command("join_employee"))
async def self_join_employee_handler(message: types.Message, state: FSMContext):
    username = message.from_user.username
    telegram_id = message.from_user.id
    if not username:
        return await message.reply("‚ùå ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ü‡ßá‡¶≤‡¶ø‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶®‡ßá‡¶Æ ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶®‡ßá‡¶á‡•§ ‡¶¶‡¶Ø‡¶º‡¶æ ‡¶ï‡¶∞‡ßá ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏ ‡¶•‡ßá‡¶ï‡ßá ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®‡•§")
    
    cur.execute("SELECT username, banned FROM employees WHERE username = ? OR telegram_id = ?", (username, telegram_id))
    employee_data = cur.fetchone()

    if employee_data:
        if employee_data[1]: # Check if banned
            return await message.reply("üö´ ‡¶¶‡ßÅ‡¶É‡¶ñ‡¶ø‡¶§, ‡¶Ü‡¶™‡¶®‡¶ø ‡¶è‡¶á ‡¶¨‡¶ü ‡¶•‡ßá‡¶ï‡ßá ‡¶®‡¶ø‡¶∑‡¶ø‡¶¶‡ßç‡¶ß (banned) ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡¶®‡•§ ‡¶Ü‡¶™‡¶®‡¶ø ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶π‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡¶® ‡¶®‡¶æ‡•§")
        else:
            return await message.reply("‚ÑπÔ∏è ‡¶Ü‡¶™‡¶®‡¶ø ‡¶á‡¶§‡¶ø‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá‡¶á ‡¶è‡¶ï‡¶ú‡¶® ‡¶è‡¶Æ‡¶™‡ßç‡¶≤‡¶Ø‡¶º‡¶ø ‡¶π‡¶ø‡¶∏‡ßá‡¶¨‡ßá ‡¶®‡¶ø‡¶¨‡¶®‡ßç‡¶ß‡¶ø‡¶§ ‡¶Ü‡¶õ‡ßá‡¶®‡•§")
    
    # Add to employees table with profile_set = 0 and banned = 0
    cur.execute("INSERT INTO employees (username, telegram_id, profile_set, banned) VALUES (?, ?, ?, ?)", (username, telegram_id, 0, 0))
    conn.commit()
    await message.reply(f"‚úÖ @{username} ‡¶Ü‡¶™‡¶®‡¶æ‡¶ï‡ßá ‡¶è‡¶Æ‡¶™‡ßç‡¶≤‡¶Ø‡¶º‡¶ø ‡¶π‡¶ø‡¶∏‡ßá‡¶¨‡ßá ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶≤‡ßã! ‡¶è‡¶ñ‡¶® ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶™‡¶æ‡¶≤‡¶æ‡•§")
    
    # Start profile setup FSM
    await state.set_state(ProfileSetup.name)
    await message.answer("‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ <b>‡¶™‡ßÅ‡¶∞‡ßã ‡¶®‡¶æ‡¶Æ</b> ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®:")


# --- Profile Management (FSM) ---

@dp.message(Command("set_profile", "change_profile"))
async def start_profile_setup(message: types.Message, state: FSMContext):
    username = message.from_user.username
    cur.execute("SELECT username FROM employees WHERE username = ?", (username,))
    if not cur.fetchone():
        return await message.reply("‚ùå ‡¶Ü‡¶™‡¶®‡¶ø ‡¶è‡¶Æ‡¶™‡ßç‡¶≤‡¶Ø‡¶º‡¶ø ‡¶®‡¶®‡•§`/join_employee` ‡¶ï‡¶Æ‡¶æ‡¶®‡ßç‡¶° ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßá ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶π‡¶®‡•§")
    
    await state.set_state(ProfileSetup.name)
    await message.answer("‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ <b>‡¶™‡ßÅ‡¶∞‡ßã ‡¶®‡¶æ‡¶Æ</b> ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®:")

@dp.message(ProfileSetup.name)
async def process_name(message: types.Message, state: FSMContext):
    await state.update_data(full_name=message.text)
    await message.answer("‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ <b>‡¶´‡ßã‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞</b> ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®:")
    await state.set_state(ProfileSetup.phone)

@dp.message(ProfileSetup.phone)
async def process_phone(message: types.Message, state: FSMContext):
    await state.update_data(phone_number=message.text)
    await message.answer("‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ <b>‡¶á‡¶Æ‡ßá‡¶á‡¶≤</b> ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®:")
    await state.set_state(ProfileSetup.email)

@dp.message(ProfileSetup.email)
async def process_email(message: types.Message, state: FSMContext):
    await state.update_data(email=message.text)
    await message.answer("‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ <b>‡¶¨‡¶ø‡¶ï‡¶æ‡¶∂ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞</b> ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®:")
    await state.set_state(ProfileSetup.bkash)

@dp.message(ProfileSetup.bkash)
async def process_bkash(message: types.Message, state: FSMContext):
    await state.update_data(bkash_number=message.text)
    await message.answer("‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ <b>Binance ID</b> ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®:")
    await state.set_state(ProfileSetup.binance_id)

@dp.message(ProfileSetup.binance_id)
async def process_binance(message: types.Message, state: FSMContext):
    await state.update_data(binance_id=message.text)
    await message.answer("‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ <b>Youtube Link</b> (‡¶Ø‡¶¶‡¶ø ‡¶•‡¶æ‡¶ï‡ßá) ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®:")
    await state.set_state(ProfileSetup.youtube)

@dp.message(ProfileSetup.youtube)
async def process_youtube(message: types.Message, state: FSMContext):
    await state.update_data(youtube_link=message.text)
    await message.answer("‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ <b>Facebook Link</b> (‡¶Ø‡¶¶‡¶ø ‡¶•‡¶æ‡¶ï‡ßá) ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®:")
    await state.set_state(ProfileSetup.facebook)

@dp.message(ProfileSetup.facebook)
async def process_facebook(message: types.Message, state: FSMContext):
    await state.update_data(facebook_link=message.text)
    await message.answer("‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ <b>TikTok Link</b> (‡¶Ø‡¶¶‡¶ø ‡¶•‡¶æ‡¶ï‡ßá) ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®:")
    await state.set_state(ProfileSetup.tiktok)

@dp.message(ProfileSetup.tiktok)
async def process_tiktok(message: types.Message, state: FSMContext):
    await state.update_data(tiktok_link=message.text)
    await message.answer("‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ <b>Website Link</b> (‡¶Ø‡¶¶‡¶ø ‡¶•‡¶æ‡¶ï‡ßá) ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®:")
    await state.set_state(ProfileSetup.website)

@dp.message(ProfileSetup.website)
async def process_website(message: types.Message, state: FSMContext):
    await state.update_data(website_link=message.text)
    
    user_data = await state.get_data()
    username = message.from_user.username

    cur.execute("""
        UPDATE employees SET
        profile_set = ?, full_name = ?, phone_number = ?, email = ?,
        bkash_number = ?, binance_id = ?, youtube_link = ?,
        facebook_link = ?, tiktok_link = ?, website_link = ?,
        about_yourself = ?
        WHERE username = ?
    """, (
        1, user_data['full_name'], user_data['phone_number'], user_data['email'],
        user_data['bkash_number'], user_data['binance_id'], user_data['youtube_link'],
        user_data['facebook_link'], user_data['tiktok_link'], user_data['website_link'],
        user_data['about_yourself'], username
    ))
    conn.commit()
    
    await message.reply("‚úÖ ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶∏‡ßá‡¶ü/‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!")
    await state.clear()

@dp.message(Command("my_profile"))
async def my_profile_handler(message: types.Message):
    username = message.from_user.username
    if not username:
        return await message.reply("‚ùå ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ü‡ßá‡¶≤‡¶ø‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶®‡ßá‡¶Æ ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶®‡ßá‡¶á‡•§")
    
    cur.execute("""
        SELECT full_name, phone_number, email, bkash_number, binance_id,
               youtube_link, facebook_link, tiktok_link, website_link, about_yourself,
               profile_set
        FROM employees WHERE username = ?
    """, (username,))
    profile_data = cur.fetchone()

    if not profile_data:
        return await message.reply("‚ùå ‡¶Ü‡¶™‡¶®‡¶ø ‡¶è‡¶ï‡¶ú‡¶® ‡¶®‡¶ø‡¶¨‡¶®‡ßç‡¶ß‡¶ø‡¶§ ‡¶ï‡¶∞‡ßç‡¶Æ‡¶ö‡¶æ‡¶∞‡ßÄ ‡¶®‡¶®‡•§ `/join_employee` ‡¶ï‡¶Æ‡¶æ‡¶®‡ßç‡¶° ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßá ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶π‡¶®‡•§")
    
    (full_name, phone, email, bkash, binance, youtube, facebook, tiktok, website, about, profile_set) = profile_data

    if not profile_set:
        return await message.reply("‚ö†Ô∏è ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶®‡ßá‡¶á‡•§ `/set_profile` ‡¶ï‡¶Æ‡¶æ‡¶®‡ßç‡¶° ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®‡•§")

    profile_text = (
        f"üë§ <b>‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤:</b>\n\n"
        f"<b>‡¶®‡¶æ‡¶Æ:</b> {full_name or 'N/A'}\n"
        f"<b>‡¶´‡ßã‡¶®:</b> {phone or 'N/A'}\n"
        f"<b>‡¶á‡¶Æ‡ßá‡¶á‡¶≤:</b> {email or 'N/A'}\n"
        f"<b>‡¶¨‡¶ø‡¶ï‡¶æ‡¶∂ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞:</b> {bkash or 'N/A'}\n"
        f"<b>Binance ID:</b> {binance or 'N/A'}\n"
        f"<b>Youtube:</b> {youtube or 'N/A'}\n"
        f"<b>Facebook:</b> {facebook or 'N/A'}\n"
        f"<b>TikTok:</b> {tiktok or 'N/A'}\n"
        f"<b>Website:</b> {website or 'N/A'}\n"
        f"<b>About:</b> {about or 'N/A'}\n\n"
        "‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡¶§‡ßá: `/change_profile`"
    )
    await message.reply(profile_text, parse_mode=ParseMode.HTML)


# --- Employee Commands List (updated) ---
@dp.message(Command("em_cmd", "my_cmd")) # Added my_cmd as an alias
async def employee_command_list(message: types.Message):
    commands_text = (
        "üìã <b>‡¶è‡¶Æ‡¶™‡ßç‡¶≤‡¶Ø‡¶º‡¶ø ‡¶ï‡¶Æ‡¶æ‡¶®‡ßç‡¶°‡¶∏‡¶Æ‡ßÇ‡¶π:</b>\n\n"
        "/start - ‡¶¨‡¶ü‡ßá‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶ï‡¶•‡¶æ ‡¶¨‡¶≤‡¶æ ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡ßÅ‡¶®\n"
        "/em_cmd (‡¶¨‡¶æ /my_cmd) - ‡¶è‡¶á ‡¶ï‡¶Æ‡¶æ‡¶®‡ßç‡¶° ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®\n"
        "/get_task - ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ü‡¶æ‡¶∏‡ßç‡¶ï ‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶™‡¶æ‡¶®\n"
        "/my_views - ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶≠‡¶ø‡¶â ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®\n"
        "/my_profile - ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶§‡¶•‡ßç‡¶Ø ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®\n"
        "/set_profile (‡¶¨‡¶æ /change_profile) - ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶∏‡ßá‡¶ü/‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®\n"
        "/my_balance - ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ USDT ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏ ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®\n"
        "/claim_usdt - ‡¶≠‡¶ø‡¶ú‡¶ø‡¶ü ‡¶•‡ßá‡¶ï‡ßá USDT ‡¶§‡ßá ‡¶∞‡ßÇ‡¶™‡¶æ‡¶®‡ßç‡¶§‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶® (‡¶®‡¶§‡ßÅ‡¶® ‡¶ï‡¶Æ‡¶æ‡¶®‡ßç‡¶°)\n" # <-- ‡¶®‡¶§‡ßÅ‡¶® ‡¶ï‡¶Æ‡¶æ‡¶®‡ßç‡¶° ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá
        "/withdraw_usdt - ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏ ‡¶â‡¶§‡ßç‡¶§‡ßã‡¶≤‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®\n"
    )
    await message.reply(commands_text, parse_mode=ParseMode.HTML)


# --- Existing Commands (modified) ---

# Admin Commands List (from previous, now with new commands and editor access notes)
@dp.message(Command("ad_cmd"))
async def admin_command_list(message: types.Message):
    if not is_admin(message.from_user.id):
        return await message.reply("‚ùå ‡¶Ü‡¶™‡¶®‡¶ø ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶®‡¶®!")
    
    commands_text = (
        "üìã <b>‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶ï‡¶Æ‡¶æ‡¶®‡ßç‡¶°‡¶∏‡¶Æ‡ßÇ‡¶π:</b>\n\n"
        "/ad_cmd - ‡¶è‡¶á ‡¶ï‡¶Æ‡¶æ‡¶®‡ßç‡¶° ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®\n"
        "/em_cmd - ‡¶è‡¶Æ‡¶™‡ßç‡¶≤‡¶Ø‡¶º‡¶ø ‡¶ï‡¶Æ‡¶æ‡¶®‡ßç‡¶° ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®\n"
        "/add_employee @username <Telegram_ID> - ‡¶®‡¶§‡ßÅ‡¶® ‡¶ï‡¶∞‡ßç‡¶Æ‡¶ö‡¶æ‡¶∞‡ßÄ ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶® (‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶ø‡¶§)\n"
        "/delete_employee @username - ‡¶ï‡¶∞‡ßç‡¶Æ‡¶ö‡¶æ‡¶∞‡ßÄ ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡ßÅ‡¶®\n"
        "/list_employees - ‡¶∏‡¶ï‡¶≤ ‡¶ï‡¶∞‡ßç‡¶Æ‡¶ö‡¶æ‡¶∞‡ßÄ‡¶∞ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶® (‡¶è‡¶°‡¶ø‡¶ü‡¶∞‡¶¶‡ßá‡¶∞‡¶ì ‡¶Ö‡¶®‡ßÅ‡¶Æ‡¶§‡¶ø ‡¶Ü‡¶õ‡ßá)\n"
        "/click_user_list - ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡¶æ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ‡¶¶‡ßá‡¶∞ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶® (‡¶è‡¶°‡¶ø‡¶ü‡¶∞‡¶¶‡ßá‡¶∞‡¶ì ‡¶Ö‡¶®‡ßÅ‡¶Æ‡¶§‡¶ø ‡¶Ü‡¶õ‡ßá)\n"
        "/band_employee @username - ‡¶ï‡¶∞‡ßç‡¶Æ‡¶ö‡¶æ‡¶∞‡ßÄ‡¶ï‡ßá ‡¶®‡¶ø‡¶∑‡¶ø‡¶¶‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®\n"
        "/add_editor @username - ‡¶ï‡¶∞‡ßç‡¶Æ‡¶ö‡¶æ‡¶∞‡ßÄ‡¶ï‡ßá ‡¶è‡¶°‡¶ø‡¶ü‡¶∞ ‡¶π‡¶ø‡¶∏‡ßá‡¶¨‡ßá ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶®\n"
        "/remove_editor @username - ‡¶ï‡¶∞‡ßç‡¶Æ‡¶ö‡¶æ‡¶∞‡ßÄ‡¶ï‡ßá ‡¶è‡¶°‡¶ø‡¶ü‡¶∞ ‡¶•‡ßá‡¶ï‡ßá ‡¶Ö‡¶™‡¶∏‡¶æ‡¶∞‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®\n"
        "/report - ‡¶ü‡¶æ‡¶∏‡ßç‡¶ï ‡¶è‡¶¨‡¶Ç ‡¶≠‡¶ø‡¶â ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶® (‡¶è‡¶°‡¶ø‡¶ü‡¶∞‡¶¶‡ßá‡¶∞‡¶ì ‡¶Ö‡¶®‡ßÅ‡¶Æ‡¶§‡¶ø ‡¶Ü‡¶õ‡ßá)\n"
        "/list_domains - ‡¶∏‡¶ï‡¶≤ ‡¶°‡ßã‡¶Æ‡ßá‡¶á‡¶® ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶® (‡¶è‡¶°‡¶ø‡¶ü‡¶∞‡¶¶‡ßá‡¶∞‡¶ì ‡¶Ö‡¶®‡ßÅ‡¶Æ‡¶§‡¶ø ‡¶Ü‡¶õ‡ßá)\n"
        "/channel_list - ‡¶Ü‡¶Æ‡¶æ‡¶¶‡ßá‡¶∞ ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤‡¶ó‡ßÅ‡¶≤‡ßã ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶® (‡¶è‡¶°‡¶ø‡¶ü‡¶∞‡¶¶‡ßá‡¶∞‡¶ì ‡¶Ö‡¶®‡ßÅ‡¶Æ‡¶§‡¶ø ‡¶Ü‡¶õ‡ßá)\n"
        "/earning_bot_list - ‡¶Ü‡¶Ø‡¶º‡ßá‡¶∞ ‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø ‡¶¨‡¶ü ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶® (‡¶è‡¶°‡¶ø‡¶ü‡¶∞‡¶¶‡ßá‡¶∞‡¶ì ‡¶Ö‡¶®‡ßÅ‡¶Æ‡¶§‡¶ø ‡¶Ü‡¶õ‡ßá)\n"
        "/site_list - ‡¶Ü‡¶Æ‡¶æ‡¶¶‡ßá‡¶∞ ‡¶ì‡¶Ø‡¶º‡ßá‡¶¨‡¶∏‡¶æ‡¶á‡¶ü‡¶ó‡ßÅ‡¶≤‡ßã ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶® (‡¶è‡¶°‡¶ø‡¶ü‡¶∞‡¶¶‡ßá‡¶∞‡¶ì ‡¶Ö‡¶®‡ßÅ‡¶Æ‡¶§‡¶ø ‡¶Ü‡¶õ‡ßá)\n"
        "/add_domain <name> <base_url> - ‡¶®‡¶§‡ßÅ‡¶® ‡¶°‡ßã‡¶Æ‡ßá‡¶á‡¶® ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®\n"
        "/delete_domain <name> - ‡¶°‡ßã‡¶Æ‡ßá‡¶á‡¶® ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡ßÅ‡¶®\n"
        "/add_channel Channel Name: <name> Channel Description: <desc> Channel Link: <link> - ‡¶®‡¶§‡ßÅ‡¶® ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®\n"
        "/add_bot Bot Name: <name> Bot Description: <desc> Bot Link: <link> - ‡¶®‡¶§‡ßÅ‡¶® ‡¶Ü‡¶∞‡ßç‡¶®‡¶ø‡¶Ç ‡¶¨‡¶ü ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®\n"
        "/set_global_task <domain_name> <task_identifier> - ‡¶∏‡¶ï‡¶≤ ‡¶ï‡¶∞‡ßç‡¶Æ‡¶ö‡¶æ‡¶∞‡ßÄ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ó‡ßç‡¶≤‡ßã‡¶¨‡¶æ‡¶≤ ‡¶ü‡¶æ‡¶∏‡ßç‡¶ï ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®\n"
        "/assign_task @username <domain_name> <task_identifier> - ‡¶®‡¶ø‡¶∞‡ßç‡¶¶‡¶ø‡¶∑‡ßç‡¶ü ‡¶ï‡¶∞‡ßç‡¶Æ‡¶ö‡¶æ‡¶∞‡ßÄ‡¶ï‡ßá ‡¶ü‡¶æ‡¶∏‡ßç‡¶ï ‡¶¶‡¶ø‡¶®\n"
        "/post_all <‡¶Ü‡¶™‡¶®‡¶æ‡¶∞_‡¶Æ‡ßá‡¶∏‡ßá‡¶ú> - ‡¶∏‡¶ï‡¶≤ ‡¶ï‡¶∞‡ßç‡¶Æ‡¶ö‡¶æ‡¶∞‡ßÄ‡¶ï‡ßá ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶™‡¶æ‡¶†‡¶æ‡¶®\n"
        "/post_to_employee @username <‡¶Ü‡¶™‡¶®‡¶æ‡¶∞_‡¶Æ‡ßá‡¶∏‡ßá‡¶ú> - ‡¶®‡¶ø‡¶∞‡ßç‡¶¶‡¶ø‡¶∑‡ßç‡¶ü ‡¶ï‡¶∞‡ßç‡¶Æ‡¶ö‡¶æ‡¶∞‡ßÄ‡¶ï‡ßá ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶™‡¶æ‡¶†‡¶æ‡¶®\n"
        "/set_usdt <amount> - ‡¶™‡ßç‡¶∞‡¶§‡¶ø 1000 ‡¶≠‡¶ø‡¶ú‡¶ø‡¶ü ‡¶è‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø USDT ‡¶∞‡ßá‡¶ü ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶® (‡¶Ø‡ßá‡¶Æ‡¶®: /set_usdt 1.00)\n"
        "/em_visit_add @username <visits> - ‡¶ï‡¶∞‡ßç‡¶Æ‡¶ö‡¶æ‡¶∞‡ßÄ‡¶∞ ‡¶≠‡¶ø‡¶ú‡¶ø‡¶ü ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶® (‡¶Ø‡ßá‡¶Æ‡¶®: /em_visit_add @user 115)\n"
        "/em_visit_minus @username <visits> - ‡¶ï‡¶∞‡ßç‡¶Æ‡¶ö‡¶æ‡¶∞‡ßÄ‡¶∞ ‡¶≠‡¶ø‡¶ú‡¶ø‡¶ü ‡¶ï‡¶æ‡¶ü‡ßÅ‡¶® (‡¶Ø‡ßá‡¶Æ‡¶®: /em_visit_minus @user 115)\n"
        "/convert_visits_to_usdt @username - ‡¶≠‡¶ø‡¶ú‡¶ø‡¶ü ‡¶•‡ßá‡¶ï‡ßá USDT ‡¶§‡ßá ‡¶∞‡ßÇ‡¶™‡¶æ‡¶®‡ßç‡¶§‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶® (‡¶è‡¶á ‡¶ï‡¶Æ‡¶æ‡¶®‡ßç‡¶° ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶®‡¶¶‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶•‡¶æ‡¶ï‡¶¨‡ßá)\n"
    )
    await message.reply(commands_text, parse_mode=ParseMode.HTML)


# Admin Employee Management (already exists, but updated for 'banned' status)
@dp.message(Command("add_employee"))
async def admin_add_employee_handler(message: types.Message):
    if not is_admin(message.from_user.id):
        return await message.reply("‚ùå ‡¶Ü‡¶™‡¶®‡¶ø ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶®‡¶®!") # Only admin can use this form of add_employee
    try:
        parts = message.text.split()
        if len(parts) < 2:
            return await message.reply("‚ö†Ô∏è ‡¶∏‡¶†‡¶ø‡¶ï‡¶≠‡¶æ‡¶¨‡ßá ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®: /add_employee @username <Telegram_ID (‡¶ê‡¶ö‡ßç‡¶õ‡¶ø‡¶ï)>")
        
        username = parts[1].replace('@', '')
        telegram_id = int(parts[2]) if len(parts) > 2 and parts[2].isdigit() else None

        cur.execute("SELECT banned FROM employees WHERE username = ?", (username,))
        existing_employee = cur.fetchone()

        if existing_employee:
            if existing_employee[0]: # If banned, unban them
                cur.execute("UPDATE employees SET banned = 0, telegram_id = ? WHERE username = ?", (telegram_id, username))
                conn.commit()
                await message.reply(f"‚úÖ @{username} (ID: {telegram_id if telegram_id else 'N/A'}) ‡¶ï‡ßá ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶Ü‡¶®‡¶¨‡ßç‡¶Ø‡¶æ‡¶® ‡¶ï‡¶∞‡¶æ ‡¶π‡¶≤‡ßã ‡¶è‡¶¨‡¶Ç ‡¶è‡¶Æ‡¶™‡ßç‡¶≤‡ßü‡¶ø ‡¶π‡¶ø‡¶∏‡ßá‡¶¨‡ßá ‡¶™‡ßÅ‡¶®‡¶É‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶≤‡ßã!")
            else:
                await message.reply(f"‚ÑπÔ∏è @{username} ‡¶á‡¶§‡¶ø‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá‡¶á ‡¶è‡¶ï‡¶ú‡¶® ‡¶è‡¶Æ‡¶™‡ßç‡¶≤‡ßü‡¶ø ‡¶π‡¶ø‡¶∏‡ßá‡¶¨‡ßá ‡¶®‡¶ø‡¶¨‡¶®‡ßç‡¶ß‡¶ø‡¶§ ‡¶Ü‡¶õ‡ßá‡¶®‡•§")
        else:
            cur.execute("INSERT INTO employees (username, telegram_id, banned) VALUES (?, ?, ?)", (username, telegram_id, 0))
            conn.commit()
            await message.reply(f"‚úÖ @{username} (ID: {telegram_id if telegram_id else 'N/A'}) ‡¶ï‡ßá ‡¶è‡¶Æ‡¶™‡ßç‡¶≤‡ßü‡¶ø ‡¶π‡¶ø‡¶∏‡ßá‡¶¨‡ßá ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶≤‡ßã!")
    except (IndexError, ValueError):
        await message.reply("‚ö†Ô∏è ‡¶∏‡¶†‡¶ø‡¶ï‡¶≠‡¶æ‡¶¨‡ßá ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®: /add_employee @username <Telegram_ID (‡¶ê‡¶ö‡ßç‡¶õ‡¶ø‡¶ï)>")
    except Exception as e:
        await message.reply(f"‚ùå ‡¶è‡¶ï‡¶ü‡¶ø ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá: {e}")

@dp.message(Command("delete_employee"))
async def delete_employee(message: types.Message):
    if not is_admin(message.from_user.id):
        return await message.reply("‚ùå ‡¶Ü‡¶™‡¶®‡¶ø ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶®‡¶®!")
    try:
        username = message.text.split()[1].replace('@', '')
        cur.execute("DELETE FROM employees WHERE username = ?", (username,))
        cur.execute("DELETE FROM individual_tasks WHERE employee_username = ?", (username,)) # Delete associated tasks
        conn.commit()
        if cur.rowcount > 0:
            await message.reply(f"‚úÖ @{username} ‡¶ï‡ßá ‡¶è‡¶Æ‡¶™‡ßç‡¶≤‡ßü‡¶ø ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ ‡¶•‡ßá‡¶ï‡ßá ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ ‡¶π‡¶≤‡ßã ‡¶è‡¶¨‡¶Ç ‡¶§‡¶æ‡¶∞ ‡¶ü‡¶æ‡¶∏‡ßç‡¶ï‡¶ó‡ßÅ‡¶≤‡ßã‡¶ì ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡¶≤‡ßã‡•§")
        else:
            await message.reply(f"‚ÑπÔ∏è @{username} ‡¶®‡¶æ‡¶Æ‡ßá ‡¶ï‡ßã‡¶®‡ßã ‡¶è‡¶Æ‡¶™‡ßç‡¶≤‡ßü‡¶ø ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§")
    except IndexError:
        await message.reply("‚ö†Ô∏è ‡¶∏‡¶†‡¶ø‡¶ï‡¶≠‡¶æ‡¶¨‡ßá ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®: /delete_employee @username")

@dp.message(Command("band_employee")) # NEW
async def band_employee_handler(message: types.Message):
    if not is_admin(message.from_user.id):
        return await message.reply("‚ùå ‡¶Ü‡¶™‡¶®‡¶ø ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶®‡¶®!")
    try:
        username = message.text.split()[1].replace('@', '')
        cur.execute("UPDATE employees SET banned = 1 WHERE username = ?", (username,))
        conn.commit()
        if cur.rowcount > 0:
            await message.reply(f"‚úÖ @{username} ‡¶ï‡ßá ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶®‡¶ø‡¶∑‡¶ø‡¶¶‡ßç‡¶ß (banned) ‡¶ï‡¶∞‡¶æ ‡¶π‡¶≤‡ßã‡•§ ‡¶∏‡ßá ‡¶Ü‡¶∞ ‡¶®‡¶ø‡¶ú‡ßá ‡¶•‡ßá‡¶ï‡ßá ‡¶ú‡ßü‡ßá‡¶® ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá ‡¶®‡¶æ‡•§")
        else:
            await message.reply(f"‚ÑπÔ∏è @{username} ‡¶®‡¶æ‡¶Æ‡ßá ‡¶ï‡ßã‡¶®‡ßã ‡¶è‡¶Æ‡¶™‡ßç‡¶≤‡ßü‡¶ø ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§")
    except IndexError:
        await message.reply("‚ö†Ô∏è ‡¶∏‡¶†‡¶ø‡¶ï‡¶≠‡¶æ‡¶¨‡ßá ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®: /band_employee @username")
    except Exception as e:
        await message.reply(f"‚ùå ‡¶è‡¶ï‡¶ü‡¶ø ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá: {e}")

@dp.message(Command("add_editor")) # NEW
async def add_editor_handler(message: types.Message):
    if not is_admin(message.from_user.id):
        return await message.reply("‚ùå ‡¶Ü‡¶™‡¶®‡¶ø ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶®‡¶®!")
    try:
        username = message.text.split()[1].replace('@', '')
        cur.execute("UPDATE employees SET is_editor = 1 WHERE username = ?", (username,))
        conn.commit()
        if cur.rowcount > 0:
            await message.reply(f"‚úÖ @{username} ‡¶ï‡ßá ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶è‡¶°‡¶ø‡¶ü‡¶∞ ‡¶π‡¶ø‡¶∏‡ßá‡¶¨‡ßá ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶≤‡ßã‡•§")
        else:
            await message.reply(f"‚ÑπÔ∏è @{username} ‡¶®‡¶æ‡¶Æ‡ßá ‡¶ï‡ßã‡¶®‡ßã ‡¶ï‡¶∞‡ßç‡¶Æ‡¶ö‡¶æ‡¶∞‡ßÄ ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§")
    except IndexError:
        await message.reply("‚ö†Ô∏è ‡¶∏‡¶†‡¶ø‡¶ï‡¶≠‡¶æ‡¶¨‡ßá ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®: /add_editor @username")
    except Exception as e:
        await message.reply(f"‚ùå ‡¶è‡¶ï‡¶ü‡¶ø ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá: {e}")

@dp.message(Command("remove_editor")) # NEW
async def remove_editor_handler(message: types.Message):
    if not is_admin(message.from_user.id):
        return await message.reply("‚ùå ‡¶Ü‡¶™‡¶®‡¶ø ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶®‡¶®!")
    try:
        username = message.text.split()[1].replace('@', '')
        cur.execute("UPDATE employees SET is_editor = 0 WHERE username = ?", (username,))
        conn.commit()
        if cur.rowcount > 0:
            await message.reply(f"‚úÖ @{username} ‡¶ï‡ßá ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶è‡¶°‡¶ø‡¶ü‡¶∞ ‡¶•‡ßá‡¶ï‡ßá ‡¶Ö‡¶™‡¶∏‡¶æ‡¶∞‡¶£ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶≤‡ßã‡•§")
        else:
            await message.reply(f"‚ÑπÔ∏è @{username} ‡¶®‡¶æ‡¶Æ‡ßá ‡¶ï‡ßã‡¶®‡ßã ‡¶ï‡¶∞‡ßç‡¶Æ‡¶ö‡¶æ‡¶∞‡ßÄ ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§")
    except IndexError:
        await message.reply("‚ö†Ô∏è ‡¶∏‡¶†‡¶ø‡¶ï‡¶≠‡¶æ‡¶¨‡ßá ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®: /remove_editor @username")
    except Exception as e:
        await message.reply(f"‚ùå ‡¶è‡¶ï‡¶ü‡¶ø ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá: {e}")

@dp.message(Command("list_employees"))
async def list_employees(message: types.Message):
    # Editors (via has_editor_permission) and Admins can use this
    if not (is_admin(message.from_user.id) or has_editor_permission(message.from_user.id, "list_employees")):
        return await message.reply("‚ùå ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶è‡¶á ‡¶ï‡¶Æ‡¶æ‡¶®‡ßç‡¶° ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡ßá‡¶∞ ‡¶Ö‡¶®‡ßÅ‡¶Æ‡¶§‡¶ø ‡¶®‡ßá‡¶á!")
    
    cur.execute("SELECT username, full_name, total_visits, usdt_balance, banned, is_editor FROM employees")
    employees = cur.fetchall()
    if not employees:
        return await message.reply("‚ÑπÔ∏è ‡¶ï‡ßã‡¶®‡ßã ‡¶è‡¶Æ‡¶™‡ßç‡¶≤‡ßü‡¶ø ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§")
    
    employee_list_text = "üë• <b>‡¶è‡¶Æ‡¶™‡ßç‡¶≤‡ßü‡¶ø‡¶¶‡ßá‡¶∞ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ:</b>\n\n"
    for emp_username, emp_full_name, total_visits, usdt_balance, banned_status, is_editor_status in employees:
        status_text = ""
        if banned_status:
            status_text += "üö´ Banned"
        if is_editor_status:
            status_text += " ‚ú® Editor"
        
        employee_list_text += (
            f"<b>@{emp_username}</b> ({emp_full_name or 'N/A'}) {status_text.strip()}\n"
            f"  üëÅÔ∏è ‡¶≠‡¶ø‡¶ú‡¶ø‡¶ü: {total_visits}, üí∞ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏: {usdt_balance:.2f} USDT\n"
        )
    await message.reply(employee_list_text, parse_mode=ParseMode.HTML)

@dp.message(Command("click_user_list")) # NEW - now also for editors
async def click_user_list_handler(message: types.Message):
    # Editors (via has_editor_permission) and Admins can use this
    if not (is_admin(message.from_user.id) or has_editor_permission(message.from_user.id, "click_user_list")):
        return await message.reply("‚ùå ‡¶Ü‡¶™‡¶®‡¶ø ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶®‡¶® ‡¶¨‡¶æ ‡¶è‡¶á ‡¶ï‡¶Æ‡¶æ‡¶®‡ßç‡¶° ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡ßá‡¶∞ ‡¶Ö‡¶®‡ßÅ‡¶Æ‡¶§‡¶ø ‡¶®‡ßá‡¶á!")
    
    # Select distinct viewer_username and viewer_full_name from clicks
    # Exclude those who are also employees
    cur.execute("""
        SELECT DISTINCT c.viewer_username, c.viewer_full_name, c.viewer_telegram_id
        FROM clicks c
        LEFT JOIN employees e ON c.viewer_username = e.username OR c.viewer_telegram_id = e.telegram_id
        WHERE e.username IS NULL
    """)
    clicked_users = cur.fetchall()

    if not clicked_users:
        return await message.reply("‚ÑπÔ∏è ‡¶ï‡ßã‡¶®‡ßã ‡¶®‡¶®-‡¶è‡¶Æ‡¶™‡ßç‡¶≤‡¶Ø‡¶º‡¶ø ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶≤‡¶ø‡¶Ç‡¶ï‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßá‡¶®‡¶ø‡•§")
    
    user_list_text = "üë§ <b>‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡¶æ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ (‡¶®‡¶®-‡¶è‡¶Æ‡¶™‡ßç‡¶≤‡ßü‡¶ø):</b>\n\n"
    for username, full_name, telegram_id in clicked_users:
        user_list_text += f"‚Ä¢ <b>{full_name or 'N/A'}</b> (@{username or 'N/A'}) [ID: {telegram_id or 'N/A'}]\n"
    await message.reply(user_list_text, parse_mode=ParseMode.HTML)

@dp.message(Command("report")) # Now also for editors
async def get_report(message: types.Message):
    if not (is_admin(message.from_user.id) or has_editor_permission(message.from_user.id, "report")):
        return await message.reply("‚ùå ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶è‡¶á ‡¶ï‡¶Æ‡¶æ‡¶®‡ßç‡¶° ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡ßá‡¶∞ ‡¶Ö‡¶®‡ßÅ‡¶Æ‡¶§‡¶ø ‡¶®‡ßá‡¶á!")
    
    report_text = "üìã <b>‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü:</b>\n\n"
    
    # Total Clicks and Visits
    cur.execute("SELECT COUNT(*), SUM(CASE WHEN is_visit = 1 THEN 1 ELSE 0 END) FROM clicks")
    total_clicks, total_visits = cur.fetchone()
    report_text += f"üîó ‡¶Æ‡ßã‡¶ü ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï: {total_clicks or 0}\n"
    report_text += f"üëÅÔ∏è ‡¶Æ‡ßã‡¶ü ‡¶≠‡¶ø‡¶ú‡¶ø‡¶ü (‡ßß‡ß®+ ‡¶∏‡ßá‡¶ï‡ßá‡¶®‡ßç‡¶°): {total_visits or 0}\n\n"

    # Top Employees by Visits
    cur.execute("SELECT username, total_visits FROM employees ORDER BY total_visits DESC LIMIT 5")
    top_employees = cur.fetchall()
    if top_employees:
        report_text += "üìà <b>‡¶∂‡ßÄ‡¶∞‡ßç‡¶∑ ‡ß´ ‡¶è‡¶Æ‡¶™‡ßç‡¶≤‡ßü‡¶ø (‡¶≠‡¶ø‡¶ú‡¶ø‡¶ü ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡ßü‡ßÄ):</b>\n"
        for i, (username, visits) in enumerate(top_employees):
            report_text += f"{i+1}. @{username}: {visits} ‡¶≠‡¶ø‡¶ú‡¶ø‡¶ü\n"
        report_text += "\n"

    # Recent Withdraw Requests (Pending)
    cur.execute("""
        SELECT employee_username, usdt_amount, payment_method, payment_detail, request_date
        FROM withdraw_requests WHERE status = 'pending' ORDER BY request_date DESC LIMIT 5
    """)
    pending_withdraws = cur.fetchall()
    if pending_withdraws:
        report_text += "‚è≥ <b>‡¶∏‡¶æ‡¶Æ‡ßç‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ï ‡¶™‡ßá‡¶®‡ßç‡¶°‡¶ø‡¶Ç ‡¶â‡¶§‡ßç‡¶§‡ßã‡¶≤‡¶® ‡¶Ö‡¶®‡ßÅ‡¶∞‡ßã‡¶ß:</b>\n"
        for username, amount, method, detail, date in pending_withdraws:
            report_text += f"‚Ä¢ @{username}: {amount:.2f} USDT ({method}, {detail}) - {date}\n"
        report_text += "\n"
    else:
        report_text += "‚ÑπÔ∏è ‡¶ï‡ßã‡¶®‡ßã ‡¶™‡ßá‡¶®‡ßç‡¶°‡¶ø‡¶Ç ‡¶â‡¶§‡ßç‡¶§‡ßã‡¶≤‡¶® ‡¶Ö‡¶®‡ßÅ‡¶∞‡ßã‡¶ß ‡¶®‡ßá‡¶á‡•§\n\n"

    await message.reply(report_text, parse_mode=ParseMode.HTML)


# --- Balance and Visit Adjustment ---

@dp.message(Command("set_usdt"))
async def set_usdt_rate_handler(message: types.Message):
    if not is_admin(message.from_user.id):
        return await message.reply("‚ùå ‡¶Ü‡¶™‡¶®‡¶ø ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶®‡¶®!")
    try:
        parts = message.text.split()
        if len(parts) < 2:
            return await message.reply("‚ö†Ô∏è ‡¶∏‡¶†‡¶ø‡¶ï‡¶≠‡¶æ‡¶¨‡ßá ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®: /set_usdt <amount> (‡¶Ø‡ßá‡¶Æ‡¶®: 1.00)")
        
        usdt_amount = float(parts[1])
        if usdt_amount <= 0:
            return await message.reply("‚ùå USDT ‡¶∞‡ßá‡¶ü ‡¶Ö‡¶¨‡¶∂‡ßç‡¶Ø‡¶á 0 ‡¶è‡¶∞ ‡¶¨‡ßá‡¶∂‡¶ø ‡¶π‡¶§‡ßá ‡¶π‡¶¨‡ßá‡•§")
        
        cur.execute("INSERT OR REPLACE INTO global_settings (key, value) VALUES (?, ?)", ('usdt_rate_per_1000_visits', str(usdt_amount)))
        conn.commit()
        await message.reply(f"‚úÖ ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá 1000 ‡¶≠‡¶ø‡¶ú‡¶ø‡¶ü ‡¶è‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø USDT ‡¶∞‡ßá‡¶ü ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡¶≤‡ßã: {usdt_amount:.2f} USDT")
    except ValueError:
        await message.reply("‚ùå ‡¶Ö‡¶¨‡ßà‡¶ß ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ‡•§ ‡¶∏‡¶†‡¶ø‡¶ï‡¶≠‡¶æ‡¶¨‡ßá ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®: /set_usdt <amount>")
    except Exception as e:
        await message.reply(f"‚ùå ‡¶è‡¶ï‡¶ü‡¶ø ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá: {e}")

@dp.message(Command("em_visit_add"))
async def employee_visit_add_handler(message: types.Message):
    if not is_admin(message.from_user.id):
        return await message.reply("‚ùå ‡¶Ü‡¶™‡¶®‡¶ø ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶®‡¶®!")
    try:
        parts = message.text.split()
        if len(parts) < 3:
            return await message.reply("‚ö†Ô∏è ‡¶∏‡¶†‡¶ø‡¶ï‡¶≠‡¶æ‡¶¨‡ßá ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®: /em_visit_add @username <visits>")
        
        target_username = parts[1].replace('@', '')
        visits_to_add = int(parts[2])
        if visits_to_add <= 0:
            return await message.reply("‚ùå ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶≠‡¶ø‡¶ú‡¶ø‡¶ü ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ ‡¶Ö‡¶¨‡¶∂‡ßç‡¶Ø‡¶á 0 ‡¶è‡¶∞ ‡¶¨‡ßá‡¶∂‡¶ø ‡¶π‡¶§‡ßá ‡¶π‡¶¨‡ßá‡•§")
        
        cur.execute("UPDATE employees SET total_visits = total_visits + ? WHERE username = ?", (visits_to_add, target_username))
        conn.commit()
        if cur.rowcount == 0:
            return await message.reply(f"‚ÑπÔ∏è @{target_username} ‡¶®‡¶æ‡¶Æ‡ßá ‡¶ï‡ßã‡¶®‡ßã ‡¶ï‡¶∞‡ßç‡¶Æ‡¶ö‡¶æ‡¶∞‡ßÄ ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§")
        
        await message.reply(f"‚úÖ @{target_username} ‡¶è‡¶∞ ‡¶≠‡¶ø‡¶ú‡¶ø‡¶ü ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ‡¶Ø‡¶º {visits_to_add} ‡¶≠‡¶ø‡¶ú‡¶ø‡¶ü ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡¶≤‡ßã‡•§")
    except ValueError:
        await message.reply("‚ùå ‡¶Ö‡¶¨‡ßà‡¶ß ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ‡•§ ‡¶∏‡¶†‡¶ø‡¶ï‡¶≠‡¶æ‡¶¨‡ßá ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®: /em_visit_add @username <visits>")
    except Exception as e:
        await message.reply(f"‚ùå ‡¶è‡¶ï‡¶ü‡¶ø ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá: {e}")

@dp.message(Command("em_visit_minus"))
async def employee_visit_minus_handler(message: types.Message):
    if not is_admin(message.from_user.id):
        return await message.reply("‚ùå ‡¶Ü‡¶™‡¶®‡¶ø ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶®‡¶®!")
    try:
        parts = message.text.split()
        if len(parts) < 3:
            return await message.reply("‚ö†Ô∏è ‡¶∏‡¶†‡¶ø‡¶ï‡¶≠‡¶æ‡¶¨‡ßá ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®: /em_visit_minus @username <visits>")
        
        target_username = parts[1].replace('@', '')
        visits_to_minus = int(parts[2])
        if visits_to_minus <= 0:
            return await message.reply("‚ùå ‡¶ï‡¶Æ‡¶æ‡¶®‡ßã‡¶∞ ‡¶≠‡¶ø‡¶ú‡¶ø‡¶ü ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ ‡¶Ö‡¶¨‡¶∂‡ßç‡¶Ø‡¶á 0 ‡¶è‡¶∞ ‡¶¨‡ßá‡¶∂‡¶ø ‡¶π‡¶§‡ßá ‡¶π‡¶¨‡ßá‡•§")
        
        # Ensure total_visits doesn't go below zero
        cur.execute("UPDATE employees SET total_visits = MAX(0, total_visits - ?) WHERE username = ?", (visits_to_minus, target_username))
        conn.commit()
        if cur.rowcount == 0:
            return await message.reply(f"‚ÑπÔ∏è @{target_username} ‡¶®‡¶æ‡¶Æ‡ßá ‡¶ï‡ßã‡¶®‡ßã ‡¶ï‡¶∞‡ßç‡¶Æ‡¶ö‡¶æ‡¶∞‡ßÄ ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§")
        
        await message.reply(f"‚úÖ @{target_username} ‡¶è‡¶∞ ‡¶≠‡¶ø‡¶ú‡¶ø‡¶ü ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ ‡¶•‡ßá‡¶ï‡ßá {visits_to_minus} ‡¶≠‡¶ø‡¶ú‡¶ø‡¶ü ‡¶ï‡¶Æ‡¶æ‡¶®‡ßã ‡¶π‡¶≤‡ßã‡•§")
    except ValueError:
        await message.reply("‚ùå ‡¶Ö‡¶¨‡ßà‡¶ß ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ‡•§ ‡¶∏‡¶†‡¶ø‡¶ï‡¶≠‡¶æ‡¶¨‡ßá ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®: /em_visit_minus @username <visits>")
    except Exception as e:
        await message.reply(f"‚ùå ‡¶è‡¶ï‡¶ü‡¶ø ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá: {e}")

# --- ADMIN COMMAND: Convert total_visits to usdt_balance (still admin only for specific employee conversion) ---
@dp.message(Command("convert_visits_to_usdt"))
async def convert_visits_to_usdt_handler(message: types.Message):
    if not is_admin(message.from_user.id):
        return await message.reply("‚ùå ‡¶Ü‡¶™‡¶®‡¶ø ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶®‡¶®!")
    try:
        parts = message.text.split()
        if len(parts) < 2:
            return await message.reply("‚ö†Ô∏è ‡¶∏‡¶†‡¶ø‡¶ï‡¶≠‡¶æ‡¶¨‡ßá ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®: /convert_visits_to_usdt @username")
        
        target_username = parts[1].replace('@', '')

        cur.execute("SELECT total_visits, usdt_balance FROM employees WHERE username = ?", (target_username,))
        employee_data = cur.fetchone()

        if not employee_data:
            return await message.reply(f"‚ÑπÔ∏è @{target_username} ‡¶®‡¶æ‡¶Æ‡ßá ‡¶ï‡ßã‡¶®‡ßã ‡¶ï‡¶∞‡ßç‡¶Æ‡¶ö‡¶æ‡¶∞‡ßÄ ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§")
        
        total_visits = employee_data[0]
        current_usdt_balance = employee_data[1]

        if total_visits == 0:
            return await message.reply(f"‚ÑπÔ∏è @{target_username} ‡¶è‡¶∞ ‡¶ï‡ßã‡¶®‡ßã ‡¶®‡¶§‡ßÅ‡¶® ‡¶≠‡¶ø‡¶ú‡¶ø‡¶ü ‡¶®‡ßá‡¶á ‡¶Ø‡¶æ USDT ‡¶§‡ßá ‡¶ï‡¶®‡¶≠‡¶æ‡¶∞‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶¨‡ßá‡•§")

        cur.execute("SELECT value FROM global_settings WHERE key = 'usdt_rate_per_1000_visits'")
        usdt_rate_str = cur.fetchone()
        usdt_rate = float(usdt_rate_str[0]) if usdt_rate_str else 0.0

        if usdt_rate == 0.0:
            return await message.reply("‚ùå USDT ‡¶∞‡ßá‡¶ü ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶®‡ßá‡¶á‡•§ ‡¶¶‡¶Ø‡¶º‡¶æ ‡¶ï‡¶∞‡ßá ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® `/set_usdt` ‡¶ï‡¶Æ‡¶æ‡¶®‡ßç‡¶° ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßá ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®‡•§")

        usdt_to_add = (total_visits / 1000) * usdt_rate

        # Update usdt_balance and reset total_visits
        cur.execute("UPDATE employees SET usdt_balance = ?, total_visits = 0 WHERE username = ?",
                    (current_usdt_balance + usdt_to_add, target_username))
        conn.commit()

        await message.reply(f"‚úÖ @{target_username} ‡¶è‡¶∞ {total_visits} ‡¶≠‡¶ø‡¶ú‡¶ø‡¶ü ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá {usdt_to_add:.2f} USDT ‡¶§‡ßá ‡¶ï‡¶®‡¶≠‡¶æ‡¶∞‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§ ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶â‡¶§‡ßç‡¶§‡ßã‡¶≤‡¶®‡¶Ø‡ßã‡¶ó‡ßç‡¶Ø ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏: {current_usdt_balance + usdt_to_add:.2f} USDT‡•§ ‡¶≠‡¶ø‡¶ú‡¶ø‡¶ü ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ ‡ß¶ ‡¶§‡ßá ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡¶≤‡ßã‡•§")

    except ValueError:
        await message.reply("‚ùå ‡¶Ö‡¶¨‡ßà‡¶ß ‡¶á‡¶®‡¶™‡ßÅ‡¶ü‡•§")
    except Exception as e:
        await message.reply(f"‚ùå ‡¶è‡¶ï‡¶ü‡¶ø ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá: {e}")

# --- EMPLOYEE COMMAND: Convert own total_visits to usdt_balance ---
@dp.message(Command("claim_usdt"))
async def claim_usdt_handler(message: types.Message):
    username = message.from_user.username
    if not username:
        return await message.reply("‚ùå ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ü‡ßá‡¶≤‡¶ø‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶®‡ßá‡¶Æ ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶®‡ßá‡¶á‡•§")

    cur.execute("SELECT total_visits, usdt_balance FROM employees WHERE username = ?", (username,))
    employee_data = cur.fetchone()

    if not employee_data:
        return await message.reply("‚ùå ‡¶Ü‡¶™‡¶®‡¶ø ‡¶è‡¶ï‡¶ú‡¶® ‡¶®‡¶ø‡¶¨‡¶®‡ßç‡¶ß‡¶ø‡¶§ ‡¶ï‡¶∞‡ßç‡¶Æ‡¶ö‡¶æ‡¶∞‡ßÄ ‡¶®‡¶®‡•§ `/join_employee` ‡¶ï‡¶Æ‡¶æ‡¶®‡ßç‡¶° ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßá ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶π‡¶®‡•§")
    
    total_visits = employee_data[0]
    current_usdt_balance = employee_data[1]

    if total_visits == 0:
        return await message.reply("‚ÑπÔ∏è ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ï‡ßã‡¶®‡ßã ‡¶®‡¶§‡ßÅ‡¶® ‡¶≠‡¶ø‡¶ú‡¶ø‡¶ü ‡¶®‡ßá‡¶á ‡¶Ø‡¶æ USDT ‡¶§‡ßá ‡¶ï‡¶®‡¶≠‡¶æ‡¶∞‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶¨‡ßá‡•§")

    cur.execute("SELECT value FROM global_settings WHERE key = 'usdt_rate_per_1000_visits'")
    usdt_rate_str = cur.fetchone()
    usdt_rate = float(usdt_rate_str[0]) if usdt_rate_str else 0.0

    if usdt_rate == 0.0:
        return await message.reply("‚ùå USDT ‡¶∞‡ßá‡¶ü ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶®‡ßá‡¶á‡•§ ‡¶¶‡¶Ø‡¶º‡¶æ ‡¶ï‡¶∞‡ßá ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶®‡¶ï‡ßá `/set_usdt` ‡¶ï‡¶Æ‡¶æ‡¶®‡ßç‡¶° ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßá ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶¨‡¶≤‡ßÅ‡¶®‡•§")

    usdt_to_add = (total_visits / 1000) * usdt_rate

    # Update usdt_balance and reset total_visits
    cur.execute("UPDATE employees SET usdt_balance = ?, total_visits = 0 WHERE username = ?",
                (current_usdt_balance + usdt_to_add, username))
    conn.commit()

    await message.reply(f"‚úÖ ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ {total_visits} ‡¶≠‡¶ø‡¶ú‡¶ø‡¶ü ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá {usdt_to_add:.2f} USDT ‡¶§‡ßá ‡¶ï‡¶®‡¶≠‡¶æ‡¶∞‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§ ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶â‡¶§‡ßç‡¶§‡ßã‡¶≤‡¶®‡¶Ø‡ßã‡¶ó‡ßç‡¶Ø ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏: {current_usdt_balance + usdt_to_add:.2f} USDT‡•§ ‡¶≠‡¶ø‡¶ú‡¶ø‡¶ü ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ ‡ß¶ ‡¶§‡ßá ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡¶≤‡ßã‡•§")


@dp.message(Command("my_balance"))
async def my_balance_handler(message: types.Message):
    username = message.from_user.username
    if not username:
        return await message.reply("‚ùå ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ü‡ßá‡¶≤‡¶ø‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶®‡ßá‡¶Æ ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶®‡ßá‡¶á‡•§")
    
    cur.execute("SELECT total_visits, usdt_balance FROM employees WHERE username = ?", (username,))
    employee_data = cur.fetchone()

    if not employee_data:
        return await message.reply("‚ùå ‡¶Ü‡¶™‡¶®‡¶ø ‡¶è‡¶ï‡¶ú‡¶® ‡¶®‡¶ø‡¶¨‡¶®‡ßç‡¶ß‡¶ø‡¶§ ‡¶ï‡¶∞‡ßç‡¶Æ‡¶ö‡¶æ‡¶∞‡ßÄ ‡¶®‡¶®‡•§ `/join_employee` ‡¶ï‡¶Æ‡¶æ‡¶®‡ßç‡¶° ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßá ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶π‡¶®‡•§")
    
    total_visits = employee_data[0]
    current_usdt_balance = employee_data[1] 

    cur.execute("SELECT value FROM global_settings WHERE key = 'usdt_rate_per_1000_visits'")
    usdt_rate_str = cur.fetchone()
    usdt_rate = float(usdt_rate_str[0]) if usdt_rate_str else 0.0 

    calculated_usdt = (total_visits / 1000) * usdt_rate

    # Check for pending withdrawals
    cur.execute("SELECT COUNT(*) FROM withdraw_requests WHERE employee_username = ? AND status = 'pending'", (username,))
    pending_withdrawals = cur.fetchone()[0]

    await message.reply(
        f"üí∞ <b>‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏:</b>\n"
        f"üëÅÔ∏è ‡¶Æ‡ßã‡¶ü ‡¶≠‡¶ø‡¶ú‡¶ø‡¶ü: {total_visits}\n"
        f"üíµ ‡¶Ü‡¶®‡ßÅ‡¶Æ‡¶æ‡¶®‡¶ø‡¶ï USDT ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏: {calculated_usdt:.2f} USDT\n"
        f"‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶â‡¶§‡ßç‡¶§‡ßã‡¶≤‡¶®‡¶Ø‡ßã‡¶ó‡ßç‡¶Ø ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏: {current_usdt_balance:.2f} USDT\n"
        f"‡¶™‡ßá‡¶®‡ßç‡¶°‡¶ø‡¶Ç ‡¶â‡¶§‡ßç‡¶§‡ßã‡¶≤‡¶®: {pending_withdrawals}‡¶ü‡¶ø\n\n"
        f"‡¶≠‡¶ø‡¶ú‡¶ø‡¶ü ‡¶•‡ßá‡¶ï‡ßá USDT ‡¶§‡ßá ‡¶∞‡ßÇ‡¶™‡¶æ‡¶®‡ßç‡¶§‡¶∞ ‡¶ï‡¶∞‡¶§‡ßá: `/claim_usdt`\n" # <--- ‡¶è‡¶á ‡¶≤‡¶æ‡¶á‡¶®‡¶ü‡¶ø ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá
        f"‡¶â‡¶§‡ßç‡¶§‡ßã‡¶≤‡¶® ‡¶ï‡¶∞‡¶§‡ßá: `/withdraw_usdt`"
    , parse_mode=ParseMode.HTML)


# --- Withdrawal System (Employee Side) ---
@dp.message(Command("withdraw_usdt"))
async def start_withdraw(message: types.Message, state: FSMContext):
    username = message.from_user.username
    cur.execute("SELECT usdt_balance, profile_set, bkash_number, binance_id FROM employees WHERE username = ?", (username,))
    employee_data = cur.fetchone()

    if not employee_data:
        return await message.reply("‚ùå ‡¶Ü‡¶™‡¶®‡¶ø ‡¶è‡¶ï‡¶ú‡¶® ‡¶®‡¶ø‡¶¨‡¶®‡ßç‡¶ß‡¶ø‡¶§ ‡¶ï‡¶∞‡ßç‡¶Æ‡¶ö‡¶æ‡¶∞‡ßÄ ‡¶®‡¶®‡•§ `/join_employee` ‡¶ï‡¶Æ‡¶æ‡¶®‡ßç‡¶° ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßá ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶π‡¶®‡•§")
    
    usdt_balance = employee_data[0]
    profile_set = employee_data[1]
    bkash_number = employee_data[2]
    binance_id = employee_data[3]

    if not profile_set:
        return await message.reply("‚ö†Ô∏è ‡¶â‡¶§‡ßç‡¶§‡ßã‡¶≤‡¶® ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶Ü‡¶ó‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®: `/set_profile`")

    if usdt_balance < 1.00: # Minimum withdrawal amount
        return await message.reply(f"‚ùå ‡¶â‡¶§‡ßç‡¶§‡ßã‡¶≤‡¶®‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏‡ßá ‡¶ï‡¶Æ‡¶™‡¶ï‡ßç‡¶∑‡ßá 1.00 USDT ‡¶•‡¶æ‡¶ï‡¶§‡ßá ‡¶π‡¶¨‡ßá‡•§ ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏: {usdt_balance:.2f} USDT")

    amounts = [1.00, 5.00, 10.00, 30.00, 100.00]
    available_amounts = [amt for amt in amounts if usdt_balance >= amt]

    if not available_amounts:
        return await message.reply(f"‚ùå ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏ {usdt_balance:.2f} USDT ‡¶¶‡¶ø‡¶Ø‡¶º‡ßá ‡¶ï‡ßã‡¶®‡ßã ‡¶â‡¶§‡ßç‡¶§‡ßã‡¶≤‡¶® ‡¶∏‡¶Æ‡ßç‡¶≠‡¶¨ ‡¶®‡¶Ø‡¶º‡•§")

    keyboard = types.ReplyKeyboardMarkup(
        keyboard=[
            [types.KeyboardButton(text=f"Withdraw ${amt:.2f}")] for amt in available_amounts
        ],
        resize_keyboard=True,
        one_time_keyboard=True
    )
    await message.answer("‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶§ USDT ‡¶â‡¶§‡ßç‡¶§‡ßã‡¶≤‡¶® ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®? (‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏: {usdt_balance:.2f} USDT)", reply_markup=keyboard)
    await state.set_state(Withdrawal.amount)

@dp.message(Withdrawal.amount)
async def process_withdraw_amount(message: types.Message, state: FSMContext):
    try:
        text = message.text.replace("Withdraw $", "")
        amount = float(text)
        
        username = message.from_user.username
        cur.execute("SELECT usdt_balance FROM employees WHERE username = ?", (username,))
        current_balance = cur.fetchone()[0]

        if amount <= 0:
            return await message.reply("‚ùå ‡¶â‡¶§‡ßç‡¶§‡ßã‡¶≤‡¶®‡ßá‡¶∞ ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ ‡¶Ö‡¶¨‡¶∂‡ßç‡¶Ø‡¶á 0 ‡¶è‡¶∞ ‡¶¨‡ßá‡¶∂‡¶ø ‡¶π‡¶§‡ßá ‡¶π‡¶¨‡ßá‡•§")

        if amount > current_balance:
            return await message.reply(f"‚ùå ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏ ‡¶Ø‡¶•‡ßá‡¶∑‡ßç‡¶ü ‡¶®‡¶Ø‡¶º‡•§ ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏: {current_balance:.2f} USDT‡•§ ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶∏‡¶†‡¶ø‡¶ï ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ ‡¶¨‡ßá‡¶õ‡ßá ‡¶®‡¶ø‡¶® ‡¶¨‡¶æ ‡¶ü‡¶æ‡¶á‡¶™ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§")
        
        await state.update_data(usdt_amount=amount)

        # Ask for payment method
        keyboard = types.ReplyKeyboardMarkup(
            keyboard=[
                [types.KeyboardButton(text="Bkash")],
                [types.KeyboardButton(text="Binance")]
            ],
            resize_keyboard=True,
            one_time_keyboard=True
        )
        await message.answer("‡¶ï‡ßã‡¶® ‡¶Æ‡¶æ‡¶ß‡ßç‡¶Ø‡¶Æ‡ßá ‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶®‡¶ø‡¶§‡ßá ‡¶ö‡¶æ‡¶®?", reply_markup=keyboard)
        await state.set_state(Withdrawal.payment_method)

    except ValueError:
        await message.reply("‚ùå ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶∏‡¶†‡¶ø‡¶ï ‡¶â‡¶§‡ßç‡¶§‡ßã‡¶≤‡¶®‡ßá‡¶∞ ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ ‡¶¨‡ßá‡¶õ‡ßá ‡¶®‡¶ø‡¶® ‡¶¨‡¶æ ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ‡¶Ø‡¶º ‡¶ü‡¶æ‡¶á‡¶™ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§")
    except Exception as e:
        await message.reply(f"‚ùå ‡¶è‡¶ï‡¶ü‡¶ø ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá: {e}")
        await state.clear()

@dp.message(Withdrawal.payment_method)
async def process_withdraw_payment_method(message: types.Message, state: FSMContext):
    payment_method = message.text
    if payment_method not in ["Bkash", "Binance"]:
        return await message.reply("‚ùå ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá 'Bkash' ‡¶Ö‡¶•‡¶¨‡¶æ 'Binance' ‡¶¨‡ßá‡¶õ‡ßá ‡¶®‡¶ø‡¶®‡•§")
    
    username = message.from_user.username
    cur.execute("SELECT bkash_number, binance_id FROM employees WHERE username = ?", (username,))
    profile_data = cur.fetchone()
    bkash_number = profile_data[0]
    binance_id = profile_data[1]

    if payment_method == "Bkash" and not bkash_number:
        return await message.reply("‚ö†Ô∏è ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤‡ßá ‡¶¨‡¶ø‡¶ï‡¶æ‡¶∂ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶®‡ßá‡¶á‡•§ ‡¶¶‡¶Ø‡¶º‡¶æ ‡¶ï‡¶∞‡ßá ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶® `/set_profile`")
    if payment_method == "Binance" and not binance_id:
        return await message.reply("‚ö†Ô∏è ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤‡ßá Binance ID ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶®‡ßá‡¶á‡•§ ‡¶¶‡¶Ø‡¶º‡¶æ ‡¶ï‡¶∞‡ßá ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶® `/set_profile`")

    await state.update_data(payment_method=payment_method)
    await message.answer("‡¶â‡¶§‡ßç‡¶§‡ßã‡¶≤‡¶® ‡¶∏‡¶Æ‡ßç‡¶™‡¶∞‡ßç‡¶ï‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ï‡ßã‡¶®‡ßã ‡¶Æ‡¶®‡ßç‡¶§‡¶¨‡ßç‡¶Ø ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‡¶∏‡¶∞‡ßç‡¶¨‡ßã‡¶ö‡ßç‡¶ö ‡ß¨‡ß¶ ‡¶Ö‡¶ï‡ßç‡¶∑‡¶∞‡ßá‡¶∞ ‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶® (‡¶ê‡¶ö‡ßç‡¶õ‡¶ø‡¶ï, ‡¶®‡¶æ ‡¶•‡¶æ‡¶ï‡¶≤‡ßá '‡¶®‡¶æ' ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®):")
    await state.set_state(Withdrawal.comment)

@dp.message(Withdrawal.comment)
async def process_withdraw_comment(message: types.Message, state: FSMContext):
    comment = message.text.strip()
    if comment.lower() == '‡¶®‡¶æ':
        comment = ""
    elif len(comment) > 60:
        return await message.reply("‚ùå ‡¶Æ‡¶®‡ßç‡¶§‡¶¨‡ßç‡¶Ø ‡ß¨‡ß¶ ‡¶Ö‡¶ï‡ßç‡¶∑‡¶∞‡ßá‡¶∞ ‡¶¨‡ßá‡¶∂‡¶ø ‡¶π‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá ‡¶®‡¶æ‡•§")
    
    await state.update_data(comment=comment)
    
    data = await state.get_data()
    username = message.from_user.username
    
    amount = data['usdt_amount']
    payment_method = data['payment_method']
    
    # CORRECTED LINE:
    cur.execute("SELECT bkash_number, binance_id FROM employees WHERE username = ?", (username,))
    profile_data = cur.fetchone()
    payment_detail = profile_data[0] if payment_method == "Bkash" else profile_data[1]

    # Save withdrawal request to DB
    cur.execute("""
        INSERT INTO withdraw_requests (employee_username, usdt_amount, payment_method, payment_detail, comment)
        VALUES (?, ?, ?, ?, ?)
    """, (username, amount, payment_method, payment_detail, comment))
    conn.commit()

    # Deduct amount from user's usdt_balance
    cur.execute("UPDATE employees SET usdt_balance = usdt_balance - ? WHERE username = ?", (amount, username))
    conn.commit()

    await message.reply(
        f"‚úÖ ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶â‡¶§‡ßç‡¶§‡ßã‡¶≤‡¶®‡ßá‡¶∞ ‡¶Ö‡¶®‡ßÅ‡¶∞‡ßã‡¶ß ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!\n"
        f"‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£: {amount:.2f} USDT\n"
        f"‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶Æ‡¶æ‡¶ß‡ßç‡¶Ø‡¶Æ: {payment_method}\n"
        f"‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶°‡¶ø‡¶ü‡ßá‡¶á‡¶≤: {payment_detail}\n"
        f"‡¶Æ‡¶®‡ßç‡¶§‡¶¨‡ßç‡¶Ø: {comment if comment else '‡¶®‡ßá‡¶á'}\n\n"
        "‡¶Ü‡¶Æ‡¶æ‡¶¶‡ßá‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Ö‡¶®‡ßÅ‡¶∞‡ßã‡¶ß ‡¶™‡¶∞‡ßç‡¶Ø‡¶æ‡¶≤‡ßã‡¶ö‡¶®‡¶æ ‡¶ï‡¶∞‡¶¨‡ßá‡¶®‡•§"
    , parse_mode=ParseMode.HTML, reply_markup=types.ReplyKeyboardRemove())
    await state.clear()

# --- Web Server for handling external HTTP requests (from footer.php) ---

async def track_click_handler(request):
    try:
        data = await request.json()
        ref_by_employee = data.get('ref')
        viewer_username = data.get('viewer_username') # From JS
        viewer_telegram_id = data.get('viewer_telegram_id') # From JS
        viewer_full_name = data.get('viewer_full_name') # From JS
        user_agent = data.get('user_agent', 'Unknown User')
        page_url = data.get('page_url', 'Unknown URL')
        is_visit_flag = data.get('is_visit', False) # True if JS sends after 12s
        is_telegram_browser = data.get('is_telegram_browser', False)

        today_date = datetime.date.today().isoformat()
        # More generalized unique daily key for 20 visits per day for the same viewer on the same page
        # The key should combine viewer, date, and page_url (not ref_by_employee for uniqueness across multiple referrals to the same page)
        unique_daily_key_for_viewer_page = f"{viewer_telegram_id or viewer_username}_{today_date}_{page_url}"

        # Check if this specific page has been visited by this viewer today (to avoid double counting same page visit for the same day)
        cur.execute("SELECT id FROM clicks WHERE unique_daily_key = ? AND is_visit = 1", (unique_daily_key_for_viewer_page,))
        if cur.fetchone():
            logging.info(f"Duplicate visit for {unique_daily_key_for_viewer_page}. Skipping visit count.")
            # Still track the click if it's new, but don't increment visit count again
            # We will still log the click, but only increment total_visits once per page per day per viewer
            # However, the user also needs to prevent general 20 clicks per day.
            # So, we first check the 20 clicks limit, then the unique visit.

            # We need to refine the unique_daily_key to prevent more than 20 TOTAL clicks by the same viewer_telegram_id/viewer_username PER DAY, regardless of referrer or page.
            # The existing unique_daily_key is tied to ref_by_employee and page_url, which is too specific for the 20-visit limit.
            # Let's adjust the 20 visit limit check.

            # Check daily TOTAL click limit for this viewer (max 20 per day per viewer)
            cur.execute("""
                SELECT COUNT(*) FROM clicks 
                WHERE (viewer_telegram_id = ? OR viewer_username = ?) 
                AND STRFTIME('%Y-%m-%d', timestamp) = ?
            """, (viewer_telegram_id, viewer_username, today_date))
            
            total_clicks_today_for_viewer = cur.fetchone()[0]

            if total_clicks_today_for_viewer >= 20:
                logging.info(f"Daily total click limit reached for {viewer_username}.")
                return web.json_response({"status": "limit_reached", "message": "Daily total click limit reached for this user."})
            
            # If it's a duplicate visit for the same page/viewer, we will still record the click, but not increment employee's total_visits
            # The employee's total_visits is only for UNIQUE visits (12+ seconds) based on page_url per viewer per day.
            # If is_visit_flag is True, and it's a duplicate for unique_daily_key_for_viewer_page, we don't increment total_visits for employee.
            # But we still record this click in 'clicks' table as is_click = True.

            # Check if this specific page+employee has already been counted as a visit by this user today
            # This is for the employee's total_visits
            unique_employee_page_visit_key = f"{ref_by_employee}_{viewer_telegram_id or viewer_username}_{today_date}_{page_url}"
            cur.execute("SELECT id FROM clicks WHERE unique_daily_key = ? AND is_visit = 1", (unique_employee_page_visit_key,))
            is_duplicate_employee_page_visit = cur.fetchone() is not None

            # Insert into clicks table
            cur.execute("""
                INSERT INTO clicks (ref_by_employee, viewer_telegram_id, viewer_username, viewer_full_name,
                                    user_agent, page_url, is_visit, is_click, is_telegram_browser, unique_daily_key)
                VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
            """, (
                ref_by_employee, viewer_telegram_id, viewer_username, viewer_full_name,
                user_agent, page_url, is_visit_flag, True, is_telegram_browser, unique_employee_page_visit_key
            ))
            conn.commit()

            # Update employee's total_visits only if it's a new unique visit for them
            if is_visit_flag and not is_duplicate_employee_page_visit:
                cur.execute("UPDATE employees SET total_visits = total_visits + 1 WHERE username = ?", (ref_by_employee,))
                conn.commit()
            
            # Always update total_clicks for the employee for any new click (even if it's a duplicate visit or not a visit)
            cur.execute("UPDATE employees SET total_clicks = total_clicks + 1 WHERE username = ?", (ref_by_employee,))
            conn.commit()
            
            logging.info(f"Tracked click for ref: {ref_by_employee}, viewer: {viewer_username}, URL: {page_url}, Visit: {is_visit_flag}, Duplicate Visit: {is_duplicate_employee_page_visit}")

            if ADMIN_CHAT_ID:
                try:
                    domain_name = urlparse(page_url).netloc
                    status_emoji = "‚úÖ ‡¶≠‡¶ø‡¶ú‡¶ø‡¶ü" if is_visit_flag else "üîó ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï"
                    notification_message = (f"<b>{status_emoji} ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá!</b>\n"
                                          f"<b>‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤:</b> <code>{ref_by_employee}</code>\n"
                                          f"<b>‡¶°‡ßã‡¶Æ‡ßá‡¶á‡¶®:</b> {domain_name}\n"
                                          f"<b>‡¶™‡ßá‡¶ú URL:</b> {hcode(page_url)}\n"
                                          f"<b>‡¶≠‡¶ø‡¶â‡¶Ø‡¶º‡¶æ‡¶∞:</b> {hbold(viewer_full_name)} (@{viewer_username})\n"
                                          f"<b>‡¶¨‡ßç‡¶∞‡¶æ‡¶â‡¶ú‡¶æ‡¶∞:</b> {'Telegram' if is_telegram_browser else 'External'}\n"
                                          f"<b>‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶è‡¶ú‡ßá‡¶®‡ßç‡¶ü:</b> <code>{user_agent}</code>")
                    if is_visit_flag and is_duplicate_employee_page_visit:
                        notification_message += "\n\n(‚ÑπÔ∏è ‡¶è‡¶á ‡¶≠‡¶ø‡¶ú‡¶ø‡¶ü‡¶ü‡¶ø ‡¶Ü‡¶ú ‡¶è‡¶á ‡¶™‡ßá‡¶ú‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶á‡¶§‡¶ø‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶ó‡¶£‡¶®‡¶æ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá, ‡¶§‡¶æ‡¶á ‡¶è‡¶Æ‡¶™‡ßç‡¶≤‡¶Ø‡¶º‡¶ø‡¶∞ ‡¶≠‡¶ø‡¶ú‡¶ø‡¶ü ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ ‡¶¨‡¶æ‡¶°‡¶º‡¶æ‡¶®‡ßã ‡¶π‡¶Ø‡¶º‡¶®‡¶ø‡•§)"

                    await bot.send_message(
                        chat_id=int(ADMIN_CHAT_ID),
                        text=notification_message,
                        parse_mode=ParseMode.HTML
                    )
                except Exception as e:
                    logging.error(f"Failed to send admin notification: {e}")
            
            return web.json_response({"status": "success", "message": "Click tracked successfully"})

    except Exception as e:
        logging.error(f"Error in track_click_handler: {e}")
        return web.json_response({"status": "error", "message": str(e)}, status=500)

# --- Main function to run both polling and web server ---

async def main() -> None:
    polling_task = asyncio.create_task(dp.start_polling(bot))

    app = web.Application()
    app.router.add_post('/track-click', track_click_handler)

    port = int(os.environ.get("PORT", 8080))
    runner = web.AppRunner(app)
    await runner.setup()
    site = web.TCPSite(runner, '0.0.0.0', port)
    await site.start()
    logging.info(f"Web server started on port {port}")

    await asyncio.gather(polling_task, site._server.wait_closed())

if __name__ == '__main__':
    asyncio.run(main())
